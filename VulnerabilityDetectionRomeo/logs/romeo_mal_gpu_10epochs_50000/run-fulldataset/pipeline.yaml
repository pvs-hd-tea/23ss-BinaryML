meta:
  - name: ROMEO Mk2 Pipeline (full dataset)

# Global config
configuration:
  seed: 985674720
  label_strategy: BINARYCLASSIFICATION
  model_name: microsoft/codebert-base

steps:
  # Start with the dataset, load it
  - name: Enumerate all CWES
    enumerate_cwes:
  - name: Enumerate all testcases
    enumerate_testcases:
  
  # Make our selection
  - name: Filter testcases with object files
    filter_testcases:
      function: has_object_file

  - name: Remove unused CWEs
    filter_cwes:
      function: has_testcase
  
  # Get some stats
  - name: Print CWE stats
    print_testcases_per_cwe:
      comment: after filtering
  
  # Extract examples
  - name: Validate testcase files before extraction
    validate_testcase_files:
  - name: Extract examples
    extract_examples:
      label_granularity: FUNCTION
      context_granularity: OBJECT
  - name: Remove duplicate examples
    remove_duplicate_examples:
  - name: Label examples
    label_examples:
  
  # Split dataset
  - name: Split dataset
    assign_split_to_examples:
      validation_fraction: .2
      test_fraction: .1

  # Checkpoint for move to HPDA cluster
  - name: Save state for cluster execution
    checkpoint:
      checkpoint_name: before-training
    
  - name: Train BPE tokenizer
    train_tokenizer:
  - name: Tokenize all examples
    tokenize_examples:
  - name: Train classifier
    train_classifier:
  
  # Eval time!
  - name: Gather predictions (train)
    predict_split:
      split: Training
  - name: Gather predictions (val)
    predict_split:
      split: Validation
  - name: Gather predictions (test)
    predict_split:
      split: Test

  - name: Save results
    checkpoint:
      checkpoint_name: after-prediction
  
  - name: Evaluate results (train)
    evaluate_predictions:
      split: Training
  - name: Evaluate results (val)
    evaluate_predictions:
      split: Validation
  - name: Evaluate results (test)
    evaluate_predictions:
      split: Test
  
  - name: Print evaluation tables (per cwe)
    print_evaluation_table:
      split: Test
      collection: PerCWE
      keys:
        - TotalExamples
        - F1
        - Accuracy
  - name: Print evaluation tables (per flow variant)
    print_evaluation_table:
      split: Test
      collection: PerFlowVariant
      keys:
        - TotalExamples
        - F1
        - Accuracy
  - name: Print evaluation tables (for BVDetector comparison)
    print_evaluation_table:
      split: Test
      collection: BVDetector
      keys:
        - TotalExamples
        - F1
        - Accuracy